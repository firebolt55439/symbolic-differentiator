"use strict";
var _ = require("lodash");
var clc = require("cli-color");
var api = require("./api");
var getProjectId = require("./getProjectId");
var requireAuth = require("./requireAuth");
var utils = require("./utils");
var logger = require("./logger");
var BASE_PERMISSIONS = ["firebase.projects.get"];
module.exports = function (options, permissions) {
    var projectId = getProjectId(options);
    var requiredPermissions = BASE_PERMISSIONS.concat(permissions || []).sort();
    return requireAuth(options)
        .then(function () {
        logger.debug("[iam] checking project", projectId, "for permissions", JSON.stringify(requiredPermissions));
        return api.request("POST", "/v1/projects/" + projectId + ":testIamPermissions", {
            auth: true,
            data: {
                permissions: requiredPermissions,
            },
            origin: api.resourceManagerOrigin,
        });
    })
        .then(function (response) {
        var allowedPermissions = (response.body.permissions || []).sort();
        var missingPermissions = _.difference(requiredPermissions, allowedPermissions);
        if (missingPermissions.length > 0) {
            return utils.reject("Authorization failed. This account is missing the following required permissions on project " +
                clc.bold(projectId) +
                ":\n\n  " +
                missingPermissions.join("\n  "));
        }
        return true;
    });
};
//# sourceMappingURL=requirePermissions.js.map