"use strict";
var _ = require("lodash");
var gcp = require("../gcp");
var pollOperations = require("../pollOperations");
function _pollKitFunctions(operations) {
    var pollFunction = gcp.cloudfunctions.check;
    var interval = 2 * 1000;
    var retryCondition = function (result) {
        var retryableCodes = [
            1,
            4,
            10,
            14,
        ];
        if (_.includes(retryableCodes, result.error.code)) {
            return true;
        }
        return false;
    };
    var success = function (op) {
        return Promise.resolve(_.last(op.func.split("/")).match(/[^-]*/)[0]);
    };
    var fail = function (op) {
        return Promise.reject({
            kit: _.last(op.func.split("/")).match(/[^-]*/)[0],
            reason: op.error.message,
        });
    };
    return pollOperations.pollAndRetry(operations, pollFunction, interval, success, fail, retryCondition);
}
module.exports = function (operations, printSuccess, printFail) {
    return _pollKitFunctions(operations)
        .then(function (successes) {
        return printSuccess(successes);
    })
        .catch(function (reason) {
        return printFail(reason);
    });
};
//# sourceMappingURL=pollKits.js.map